<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>indicium</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="code-challenge">code-challenge</h1>
<p><em>Written by Aluizio Cidral Júnior</em></p>
<p>Resolution of Indicium Code challenge for Software Developer</p>
<h2 id="the-challenge-synopsis">The Challenge Synopsis</h2>
<p>Build a pipeline that extracts the data everyday from two sources and write the data first to local disk, and second to a database.</p>
<div class="mermaid"><svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-mr5bl7LXqNwKcqS5" width="100%" style="max-width: 444.26666259765625px;" viewBox="0 0 444.26666259765625 159.43331909179688"><g transform="translate(-12, -12)"><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath" style="opacity: 1;"><path class="path" d="M100.11666870117188,43.35832977294922L125.11666870117188,43.35832977294922L173.10047319008024,68.35832977294922" marker-end="url(#arrowhead88)" style="fill:none"></path><defs><marker id="arrowhead88" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M99.3499984741211,140.07498931884766L125.11666870117188,140.07498931884766L173.10047319008024,115.07498931884766" marker-end="url(#arrowhead89)" style="fill:none"></path><defs><marker id="arrowhead89" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M285.75,91.71665954589844L310.75,91.71665954589844L335.75,91.71665954589844" marker-end="url(#arrowhead90)" style="fill:none"></path><defs><marker id="arrowhead90" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" style="opacity: 1;" transform=""><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform=""><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel" style="opacity: 1;" transform=""><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g class="node" style="opacity: 1;" id="A" transform="translate(60.05833435058594,43.35832977294922)"><rect rx="0" ry="0" x="-40.05833435058594" y="-23.35832977294922" width="80.11666870117188" height="46.71665954589844"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-30.058334350585938,-13.358329772949219)"><foreignObject width="60.116668701171875" height="26.716659545898438"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Postgres</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="B" transform="translate(217.93333435058594,91.71665954589844)"><rect rx="0" ry="0" x="-67.81666564941406" y="-23.35832977294922" width="135.63333129882812" height="46.71665954589844"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-57.81666564941406,-13.358329772949219)"><foreignObject width="115.63333129882812" height="26.716659545898438"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Local FileSystem</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="C" transform="translate(60.05833435058594,140.07498931884766)"><rect rx="0" ry="0" x="-39.291664123535156" y="-23.35832977294922" width="78.58332824707031" height="46.71665954589844"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-29.291664123535156,-13.358329772949219)"><foreignObject width="58.58332824707031" height="26.716659545898438"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">CSV File</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="D" transform="translate(392.0083312988281,91.71665954589844)"><rect rx="0" ry="0" x="-56.258331298828125" y="-23.35832977294922" width="112.51666259765625" height="46.71665954589844"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-46.258331298828125,-13.358329772949219)"><foreignObject width="92.51666259765625" height="26.716659545898438"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">My Database</div></foreignObject></g></g></g></g></g></g></svg></div>
<p>More info about the challenge can be found at: <a href="https://github.com/techindicium/code-challenge">https://github.com/techindicium/code-challenge</a></p>
<h2 id="solution">Solution</h2>
<p>To achieve the challenge goal I decided to work with <a href="airflow.apache.org/">Airflow</a>, which is a tool to describing, executing and monitoring workflows.</p>
<p>Airflow works with DAG (Directed Acyclic Graph) to group  and organize tasks.</p>
<h3 id="tasks">Tasks</h3>
<p>For this pipeline there are three main tasks:</p>
<ol>
<li>Extract data from Postgres database and write to local disk</li>
<li>Extract data from CSV file and write to local disk</li>
<li>Extract data from local filesystem, transform and load to final database</li>
</ol>
<p>Every task was write as a Python script:</p>
<p><strong>Task1:</strong> Connects to Postgress Database, gets the names of all tables and write the data in the local file with path for each source, table and execution day.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span>  psycopg2
<span class="token keyword">import</span>  pandas  <span class="token keyword">as</span>  pd
<span class="token keyword">import</span>  os
<span class="token keyword">import</span>  sys

date <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>

<span class="token comment">#PostgreSQL Connection</span>
host <span class="token operator">=</span> <span class="token string">"postgres-container-indicium"</span>
database <span class="token operator">=</span> <span class="token string">"northwind"</span>
user <span class="token operator">=</span> <span class="token string">"northwind_user"</span>
password <span class="token operator">=</span> <span class="token string">"thewindisblowing"</span>
  
db_conn <span class="token operator">=</span> psycopg2<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span>database <span class="token operator">=</span> database<span class="token punctuation">,</span> user <span class="token operator">=</span> user<span class="token punctuation">,</span> password <span class="token operator">=</span> password<span class="token punctuation">)</span>
db_cursor <span class="token operator">=</span> db_conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span>  <span class="token function">get_table_names</span><span class="token punctuation">(</span>db_cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
	table_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	db_cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""SELECT table_name FROM information_schema.tables
	WHERE table_schema = 'public'"""</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span>  name  <span class="token keyword">in</span>  db_cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		table_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>  table_names
 
<span class="token keyword">def</span>  <span class="token function">csv_export</span><span class="token punctuation">(</span>db_cursor<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>
	select <span class="token operator">=</span> <span class="token triple-quoted-string string">"""SELECT * FROM {0}"""</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span>
	SQL_for_file_output <span class="token operator">=</span> <span class="token string">"COPY ({0}) TO STDOUT WITH CSV HEADER"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>select<span class="token punctuation">)</span>
	path_file <span class="token operator">=</span> <span class="token string">"/data/postgres/{0}/{1}/data.csv"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span>date<span class="token punctuation">)</span>
	os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>path_file<span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
	<span class="token keyword">with</span>  <span class="token builtin">open</span><span class="token punctuation">(</span>path_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  f_output<span class="token punctuation">:</span>
		db_cursor<span class="token punctuation">.</span>copy_expert<span class="token punctuation">(</span>SQL_for_file_output<span class="token punctuation">,</span> f_output<span class="token punctuation">)</span>

<span class="token keyword">for</span>  table_name  <span class="token keyword">in</span>  get_table_names<span class="token punctuation">(</span>db_cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
	csv_export<span class="token punctuation">(</span>db_cursor<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span>date<span class="token punctuation">)</span>
</code></pre>
<p><strong>Task 2:</strong> Copies the csv file and write in the local file with path for each source, table and execution day.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span>  shutil
<span class="token keyword">import</span>  os
<span class="token keyword">import</span>  sys

date <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>

input_file <span class="token operator">=</span> <span class="token string">"/data/order_details.csv"</span>
output <span class="token operator">=</span> <span class="token string">"/data/csv/{0}/data.csv"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>
os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>input_file<span class="token punctuation">,</span>output<span class="token punctuation">)</span>
</code></pre>
<p><strong>Task 3:</strong> Extracts local data, joins tables and saves as json in Mongo database. I choose the json format because it’s possible to list products of same order in the same json. Make things easy for a Front End Developer if hes wants to show the order details with the list of products inside.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span>  collections
<span class="token keyword">from</span>  numpy  <span class="token keyword">import</span>  product
<span class="token keyword">import</span>  pandas  <span class="token keyword">as</span>  pd
<span class="token keyword">from</span>  pymongo  <span class="token keyword">import</span>  MongoClient
<span class="token keyword">import</span>  sys

date <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>

<span class="token comment">#Extract local data</span>
orders <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"/data/postgres/orders/{0}/data.csv"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span>
products <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"/data/postgres/products/{0}/data.csv"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span>
customers <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"/data/postgres/customers/{0}/data.csv"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span>
order_details <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"/data/csv/{0}/data.csv"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#Transform</span>
orders <span class="token operator">=</span> orders<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'order_id'</span><span class="token punctuation">,</span><span class="token string">'order_date'</span><span class="token punctuation">,</span><span class="token string">'customer_id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'order_id'</span><span class="token punctuation">)</span>
products <span class="token operator">=</span> products<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'product_id'</span><span class="token punctuation">,</span><span class="token string">'product_name'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'product_id'</span><span class="token punctuation">)</span>
customers <span class="token operator">=</span> customers<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'customer_id'</span><span class="token punctuation">,</span><span class="token string">'company_name'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'customer_id'</span><span class="token punctuation">)</span>
orders <span class="token operator">=</span> orders<span class="token punctuation">.</span>join<span class="token punctuation">(</span>customers<span class="token punctuation">,</span> on <span class="token operator">=</span> <span class="token string">'customer_id'</span><span class="token punctuation">)</span>
order_details <span class="token operator">=</span> order_details<span class="token punctuation">.</span>join<span class="token punctuation">(</span>products<span class="token punctuation">,</span> on <span class="token operator">=</span> <span class="token string">'product_id'</span><span class="token punctuation">)</span>

data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span>  order_id  <span class="token keyword">in</span>  order_details<span class="token punctuation">.</span>order_id<span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	json <span class="token operator">=</span> order_details<span class="token punctuation">[</span>order_details<span class="token punctuation">.</span>order_id <span class="token operator">==</span> order_id<span class="token punctuation">]</span><span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token string">"order_id"</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token string">"records"</span><span class="token punctuation">)</span>
	order <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token string">"order_id"</span><span class="token punctuation">:</span> order_id<span class="token punctuation">,</span>
		<span class="token string">"order_date"</span><span class="token punctuation">:</span> orders<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>order_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'order_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">"company_name"</span><span class="token punctuation">:</span> orders<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>order_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'company_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">"products"</span><span class="token punctuation">:</span> json_order<span class="token punctuation">,</span>
		<span class="token string">"db_execution_date"</span><span class="token punctuation">:</span> date
		<span class="token punctuation">}</span>
	data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>order<span class="token punctuation">)</span>

details <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token string">"records"</span><span class="token punctuation">)</span>

<span class="token comment"># Load to Database</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">'mongo-container'</span><span class="token punctuation">,</span> <span class="token number">27017</span><span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">'dharma'</span><span class="token punctuation">,</span> password <span class="token operator">=</span> <span class="token string">'4815162342'</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'orders'</span><span class="token punctuation">]</span>
collection <span class="token operator">=</span> db<span class="token punctuation">[</span><span class="token string">'details'</span><span class="token punctuation">]</span>
collection<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span>details<span class="token punctuation">)</span>
</code></pre>
<p>Output sample in Mongo database:</p>
<pre class=" language-json"><code class="prism  language-json"><span class="token punctuation">{</span>
	<span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"601b4a5a5d3951efca454d16"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token string">"order_id"</span> <span class="token punctuation">:</span> <span class="token number">10267</span><span class="token punctuation">,</span>
	<span class="token string">"order_date"</span> <span class="token punctuation">:</span> <span class="token string">"1996-07-29"</span><span class="token punctuation">,</span>
	<span class="token string">"company_name"</span> <span class="token punctuation">:</span> <span class="token string">"Frankenversand"</span><span class="token punctuation">,</span>
	<span class="token string">"products"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">"product_id"</span> <span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
			<span class="token string">"unit_price"</span> <span class="token punctuation">:</span> <span class="token number">14.7</span><span class="token punctuation">,</span>
			<span class="token string">"quantity"</span> <span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
			<span class="token string">"discount"</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token string">"product_name"</span> <span class="token punctuation">:</span> <span class="token string">"Boston Crab Meat"</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token string">"product_id"</span> <span class="token punctuation">:</span> <span class="token number">59</span><span class="token punctuation">,</span>
			<span class="token string">"unit_price"</span> <span class="token punctuation">:</span> <span class="token number">44</span><span class="token punctuation">,</span>
			<span class="token string">"quantity"</span> <span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
			<span class="token string">"discount"</span> <span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
			<span class="token string">"product_name"</span> <span class="token punctuation">:</span> <span class="token string">"Raclette Courdavault"</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token string">"product_id"</span> <span class="token punctuation">:</span> <span class="token number">76</span><span class="token punctuation">,</span>
			<span class="token string">"unit_price"</span> <span class="token punctuation">:</span> <span class="token number">14.4</span><span class="token punctuation">,</span>
			<span class="token string">"quantity"</span> <span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
			<span class="token string">"discount"</span> <span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
			<span class="token string">"product_name"</span> <span class="token punctuation">:</span> <span class="token string">"Lakkalikööri"</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token string">"db_execution_date"</span> <span class="token punctuation">:</span> <span class="token string">"2015-01-01"</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="dag">DAG</h3>
<p>One of requirements is that Task 3 depends on Task 1 and Task 2, so tasks 1 and 2 has to run successfully before task 3 can run. To deal with these dependencies Airflow needs a DAG file. The last line in the next code imposes these dependencies.<br>
This DAG is schedule to run at intervals of one day.</p>
<p>DAG File</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span>  airflow  <span class="token keyword">import</span>  DAG
<span class="token keyword">from</span>  datetime  <span class="token keyword">import</span>  datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span>  airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>bash_operator  <span class="token keyword">import</span>  BashOperator
<span class="token keyword">from</span>  airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>dates  <span class="token keyword">import</span>  days_ago

default_args <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token string">'owner'</span><span class="token punctuation">:</span> <span class="token string">'Aluizio Cidral Júnior'</span><span class="token punctuation">,</span>
<span class="token string">'depends_on_past'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token string">'start_date'</span><span class="token punctuation">:</span> days_ago<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string">'retries'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">with</span>  DAG<span class="token punctuation">(</span>
<span class="token string">'DAG'</span><span class="token punctuation">,</span>
schedule_interval<span class="token operator">=</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
default_args<span class="token operator">=</span>default_args
<span class="token punctuation">)</span> <span class="token keyword">as</span>  dag<span class="token punctuation">:</span>

	t1 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
	task_id<span class="token operator">=</span><span class="token string">'task1'</span><span class="token punctuation">,</span>
	bash_command<span class="token operator">=</span><span class="token triple-quoted-string string">"""
	cd $AIRFLOW_HOME/dags/tasks/
	python3 task1.py {{ execution_date }}
	"""</span><span class="token punctuation">)</span>
	t2 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
	task_id<span class="token operator">=</span><span class="token string">'task2'</span><span class="token punctuation">,</span>
	bash_command<span class="token operator">=</span><span class="token triple-quoted-string string">"""
	cd $AIRFLOW_HOME/dags/tasks/
	python3 task2.py {{ execution_date }}
	"""</span><span class="token punctuation">)</span>

	t3 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
	task_id<span class="token operator">=</span><span class="token string">'task3'</span><span class="token punctuation">,</span>
	bash_command<span class="token operator">=</span><span class="token triple-quoted-string string">"""
	cd $AIRFLOW_HOME/dags/tasks/
	python3 task3.py {{ execution_date }}
	"""</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span>t1<span class="token punctuation">,</span>t2<span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> t3
</code></pre>
<h2 id="setup-of-the-solution">Setup of the Solution</h2>
<p>I used Docker to containerize  my solution. The source code can be set up using docker compose. You can install following the instructions at <a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a><br>
With docker compose installed simply run:</p>
<pre><code>docker-compose up
</code></pre>
<h2 id="testing-the-pipeline">Testing the Pipeline</h2>
<p>After you set up my code, it is possible to test each task or the whole pipeline in the past.<br>
Access the Airflow container:</p>
<pre><code>docker exec -it airflow-container bash
</code></pre>
<p>To test some task:</p>
<pre><code>airflow test DAG-indicium task1 2020-01-01
</code></pre>
<p>Tasks available in DAG-indicium: task1, task2, task3.</p>
<p>To run the pipeline in past days:</p>
<pre><code>airflow backfill DAG-indicium -s 2020-01-01 -e 2020-01-08
</code></pre>
<p>The output files will be load at <code>/data</code> folder.</p>
<h2 id="access-mongo-database">Access Mongo Database</h2>
<p>To access the Mongo Database (and see the outputs of task3), in terminal:</p>
<pre><code>mongo -u dharma -p 4815162342 --authenticationDatabase "admin"
</code></pre>
<p>On mongo terminal:</p>
<pre><code>&gt; use orders
&gt; db.details.find().pretty()
</code></pre>
<h2 id="monitor-and-troubleshoot">Monitor and Troubleshoot</h2>
<p>Airflow provides a web service to monitor and troubleshoot in pipelines. To start the web server:</p>
<pre><code>airflow webserver -p 8080
</code></pre>
<p>And Access by address <a href="https://localhost:8080">localhost:8080</a>.<br>
It is possible to verify if the pipeline failed there.</p>
<p>Thanks for reading!</p>
<p>Aluizio Cidral Júnior<br>
<a href="https://www.linkedin.com/in/cidraljunior/">https://www.linkedin.com/in/cidraljunior/</a><br>
<a href="https://github.com/cidraljunior/">https://github.com/cidraljunior/</a></p>
<blockquote>
<p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p>
</blockquote>
</div>
</body>

</html>
